# 1. 文件管理

## 1.1 文件控制块和索引节点

与进程管理一样，为方便操作系统方便管理文件，引入了**文件控制块**的数据结构。

1. **文件的属性**，除了文件数据外，操作系统还保存了文件的访问权限，创建时间，修改时间等信息，这些附加信息称为**文件属性**或**文件元数据**。文件属性在不同系统中，差别很大，但大多有如下属性：
   
   1. 名称，文件名称唯一，以容易读取的形式保存。
   
   2. 类型，被不同文件系统所使用。
   
   3. 创建者
   
   4. 所有者
   
   5. 位置，指向设备和设备上文件的指针。
   
   6. 大小
   
   7. 保护，对文件进行保护的访问权限。
   
   8. 创建时间，最后一次修改时间和最后一次存取时间，用于保护和跟踪文件的使用。

操作系统通过文件控制块（FCB）来维护文件元数据。
2. **文件控制块**
FCB是用来存放控制文件需要的各种信息的数据结构，以实现“按名存取”。FCB的有序集合称为文件目录，一个FCB就是一个文件目录项。
![](http://img.zqqiliyc.love/os/202303081943458.jpg)

**一个文件目录也被视为一个文件，称为目录文件**

3. **索引节点**

文件目录通常存放在磁盘上，当文件很多时，文件目录占用大量的盘块。在查找目录的过程中，要先将存放目录文件的第一个盘块调入内存，然后用给定的文件名逐一比对，若未找到指定文件，还需调入下一个块。所以，在检索目录的过程中，只用到了文件名，仅当找到一个目录项时，才需从该目录项中读出文件的物理地址，也就是说在检索目录时，文件的其他信息不会用到，也不会调入内存。因此便采用了**文件名**和**文件描述信息**分开的方法，使文件描述信息单独形成一个称为**索引节点**的数据结构，简称**i节点**，**在文件目录中的每个目录项仅由文件名和指向该文件所对应的i节点的指针构成。**

- **磁盘索引节点&内存索引节点**
  ![](http://img.zqqiliyc.love/os/202303081943689.jpg)

## 1.2 文件的操作

### 1.2.1 文件的基本操作

文件属于基本数据类型。操作系统提供系统调用，它对文件进行操作。

- 创建文件

- 写文件

- 读文件

- 重新定位文件

- 删除文件

- 截断文件，允许文件所有属性不变，并删除文件内容，将其长度置0并释放其空间

### 1.2.2 文件的打开与关闭

当用户对文件实施操作时，每次都要从检索目录开始。为了避免多次检索重复的目录，大多数操作系统要求，在文件使用之前通过系统调用open被显式打开。**操作系统维护一个包含所有打开文件信息的表（打开文件表）**。

![](http://img.zqqiliyc.love/os/202303081944034.jpg)

### 1.2.3 文件保护

1. **访问类型**

对文件的保护可从限制对文件的访问类型中出发。可加以控制的访问类型主要有以下几种：

- 读

- 写

- 执行

- 添加

- 删除

- 列表清单。列出文件名和文家属性。
2. **访问控制**

解决访问控制最常用的方式是**根据用户身份进行控制**。而根据身份进行控制的实现最为普通的方式是，为每个文件和目录增加一个**访问控制列表(Access-Control List ACL)**，以规定每个用户名及其所允许的访问类型。优点是可以使用复杂的访问方法，缺点是控制复杂。采用精简的访问列表可解决（拥有者、组、其他三种用户类型）

## 1.3 文件的存储结构

### 1.3.1 文件的逻辑结构

文件的逻辑结构是从用户角度出发看到的文件的组织形式。文件的物理结构（存储结构）是从实现观点出发看到的文件在外存上的存储组织形式。**文件的逻辑结构**与存储特性介质无关，它实际上**是指在文件的内部，数据逻辑上是如何组织起来的**。

按照逻辑结构，文件可分为两类：

- 无结构文件（流式文件）

- 有结构文件（记录式文件）
  
  - 顺序文件，记录一个接一个地顺序存储，可顺序存储或链表形式存储
    
    - 串结构，记录之间的顺序与关键字无关
    
    - 顺序结构，记录之间的顺序按关键字顺序排列
  
  - 索引文件，对文件建立索引表，表项为索引号，长度，指针ptr，指向逻辑文件
  
  - 索引顺序文件，先对文件分组，然后索引表表项存储每个组的第一个记录和对应的逻辑地址
  
  - 直接文件（散列文件）

有结构文件的逻辑结构都是为在文件中查找数据而服务的，是一种文件的“内部”结构，而下文中提到的是文件的“外部”结构的问题，即文件之间如何组织。

![](http://img.zqqiliyc.love/os/202303081945722.png)

![](http://img.zqqiliyc.love/os/202303081945649.png)

![](http://img.zqqiliyc.love/os/202303081945976.png)

![](http://img.zqqiliyc.love/os/202303081946842.png)

### 1.3.2 文件的物理存储结构

类比进程的逻辑地址与内存块的映射关系，文件也可采取此方式**逻辑地址=逻辑块号+块内地址**，操作系统负责将逻辑地址映射为物理地址，操作系统只需转换逻辑地址到物理地址的映射关系。

文件的分配方式讲的是**对磁盘非空闲块的管理**。常用的磁盘空间分配方法有如下三种：

- **连续分配方式**，要求每个文件在磁盘上是一组连续的块。文件目录中每个FCB项会记录该文件的起始块号和长度，操作系统可根据逻辑块号+起始块号直接得出物理块号，支持随机访问。缺点：文件拓展不方便；存储空间利用率低，会产生磁盘外部碎片。

- **链接分配方式**，采取离散分配的方式，各个文件块之间使用指针连接，消除了外部碎片，分为隐式链接和显示链接两种。
  
  - **隐式链接方式**，当访问某一个块时，需要从FCB记录中将起始块号读入，依次判断当前块是不是要访问的块，所以只支持顺序访问，查找效率低。通常的解决方案是，**将几个盘块组成簇，按簇而不按块来分配**，可以成倍地减少查询时间。簇可以解决大多数算法的磁盘访问时间，因此应用于大多数操作系统。
  
  - **显示链接方式**，把用于链接文件各物理块的指针显示的存放在一张表中，此表称为文件分配表(File Allocation Table)。静态链表？FAT表会常驻内存，并且每一个表项是连续存放的，每次需要访问某块时，会先根据FCB中记录的起始块号直接去FAT查找，支持随机访问也支持顺序访问，块号转换过程不需要IO操作。

- **索引分配方式**，离散分配，系统会为每个文件建立一张索引表，索引表中记录了文件的各个逻辑块对应的物理块。索引表存放的磁盘块为索引块，存放数据的为数据块，文件的FCB中记录该文件索引表所在的物理块(索引块)
  
  ![](http://img.zqqiliyc.love/os/202303081946758.png)
  
  ---

索引分配的优点是支持直接访问，且没有外部碎片问题。缺点是由于索引块的分配，增加了存储空间的开销。索引块的大小是一个重要问题，可采用如图所示的方案：
![](http://img.zqqiliyc.love/os/202303081947094.png)

- **混合索引分配方式**。为了能够较全面的照顾到各种大小的文件而采用的方式。

UNIX系统采用的就是这种分配方式。

![](http://img.zqqiliyc.love/os/202303081947094.png)

## 1.4 磁盘调度算法

### 1.4.1 一次磁盘读/写需要的时间

- **寻道时间T**,在读写数据之前，将磁头移动到指定磁道所花费的时间。
  
  - 启动磁头臂是需要时间的，假设为s
  
  - 移动磁头也是需要时间的。假设磁头匀速移动，每跨越一个磁道耗时m,总共需要跨越n个磁道，则花费时间：mn.则**共计T = s + m*n.**

- **延迟时间T**，通过旋转磁盘，使磁头定位到目标扇区所需时间。设磁盘转速为r转/s,则平均所需延迟时间为：T = (1/2) * (1/r).找到目标扇区需要转半圈

- **传输时间T**，从磁盘读出或向磁盘写入数据所经历的时间，假设磁盘转速为r，此次读写数据为b字节，假设每个磁道能够存储N字节，则T = (1/r) * (b/N).

### 1.4.2 磁盘调度算法

- **先来先服务（FCFS）**，按照进程请求访问磁盘的先后顺序进行调度。

- **最短寻找时间算法（SSTF）**，优先处理离当前磁头距离最近的请求磁道。可保证每次寻道时间最短，但不能保证总的寻道时间最短。(贪心思想)。缺点是可能产生饥饿现象

- **扫描算法（SCAN）**，SSTF的问题在于磁头可能在一个小区间内来回移动。为了防止这个问题，可以规定，**只有当磁头移动到最外侧的磁道时才能往内移动，移动到最内侧磁道的时候才能往外移动**。这就是扫描算法的思想，也成电梯算法。
  
  - 优点：性能较好，平均寻道时间较短，不会产生饥饿现象
  
  - 缺点：只有到达最边上的磁道才能改变磁头移动的方向；各个磁道的响应频率不平均。

- **LOOK算法**，解决SCAN的缺点1，边移动边观察。

- **C-SCAN算法**，循环扫描算法，解决SCAN缺点2,规定只有当磁头朝某个特定方向移动时才处理磁道访问请求，**而返回时直接移动到起始端，而不处理任何请求。**

- **C-LOOK算法**，顾名思义，，，

### 1.4.3 减少磁盘延迟时间的方法

- 交替编号

- (柱面号，盘面号，扇区号)，可减少移动磁头臂的次数

- 错位命名